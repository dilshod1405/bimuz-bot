stages:
  - build
  - test

variables:
  DOCKER_DRIVER: overlay2

docker-build:
  stage: build
  image: docker:25
  timeout: 30m
  variables:
    DOCKER_BUILDKIT: "0"
    COMPOSE_DOCKER_CLI_BUILD: "0"
  before_script:
    - docker version
  script:
    - docker build -t bimuz-bot:test .
    - docker run --rm bimuz-bot:test python --version
    - docker run --rm -e BOT_TOKEN=test_token -e API_BASE_URL=http://localhost:8000 -e REDIS_URL=redis://localhost:6379/0 bimuz-bot:test python -c "import bot; import handlers; print('All imports successful')"
  tags:
    - docker
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

docker-compose-test:
  stage: test
  image: docker:25
  timeout: 30m
  variables:
    DOCKER_BUILDKIT: "0"
    COMPOSE_DOCKER_CLI_BUILD: "0"
  before_script:
    - apk add --no-cache bash
    - docker version
    - |
      cat > .env << EOF
      BOT_TOKEN=test_token_1234567890
      API_BASE_URL=http://localhost:8000
      REDIS_URL=redis://redis:6379/0
      EOF
  script:
    - docker build -t bimuz-bot:latest .
    - docker compose version || docker-compose --version || true
    - docker pull redis:7-alpine || true
    - docker compose up -d redis || docker-compose up -d redis || true
    - sleep 5
    - docker compose up -d bot || docker-compose up -d bot || docker-compose up -d || docker-compose up -d
    - sleep 10
    - docker compose ps || docker-compose ps || docker ps
    - docker compose logs bot || docker-compose logs bot || docker logs bimuz-bot || true
    - docker compose down -v || docker-compose down -v || (docker stop bimuz-bot bimuz-bot-redis 2>/dev/null || true) && (docker rm bimuz-bot bimuz-bot-redis 2>/dev/null || true)
  tags:
    - docker
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
